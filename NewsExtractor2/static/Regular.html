<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Economic Times News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #f8f9fa;
        }

        h2 {
            font-weight: bold;
            color: #343a40;
        }

        .search-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .btn i {
            margin-right: 6px;
        }

        table th, table td {
            vertical-align: middle;
        }

        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>

    <div class="container my-5">
        <div class="text-center mb-5">
            <h2>📰 Economic Times News</h2>
            <p class="text-muted">Search and view the latest business headlines</p>
        </div>

        <div class="card search-card p-4 mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by title..." />
                </div>
                <div class="col-md-3">
                    <input type="date" id="startDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <input type="date" id="endDate" class="form-control" />
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" onclick="fetchNews()">
                        <i class="bi bi-search"></i>Search
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col d-grid">
                    <button class="btn btn-success" onclick="fetchLatest()">
                        <i class="bi bi-cloud-download"></i>Fetch Latest News
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive shadow-sm">
            <table class="table table-bordered table-hover bg-white" id="newsTable">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Published On</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody id="newsBody">
                    <!-- News rows will appear here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap Icons CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date().toISOString().split("T")[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            fetchNews(); // Auto-load
        });

        function getApiBaseUrl() {
            const url = window.location.origin.replace("/static", "");
            return `${url}/api/news`;
        }

        async function fetchNews() {
            const title = document.getElementById('searchInput').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const apiUrl = `${getApiBaseUrl()}/search?title=${encodeURIComponent(title)}&startDate=${start}&endDate=${end}`;

            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                displayNews(data);
            } catch (err) {
                console.error("Error fetching news:", err);
                alert("❌ Failed to load news. Is your API running?");
            }
        }

        async function fetchLatest() {
            try {
                const res = await fetch(`${getApiBaseUrl()}/fetchall`, {
                    method: 'POST'
                });
                const msg = await res.text();
                alert(msg);
                fetchNews();
            } catch (err) {
                console.error("Fetch error:", err);
                alert("❌ Failed to fetch latest news.");
            }
        }

        function displayNews(news) {
            const tbody = document.getElementById('newsBody');
            tbody.innerHTML = "";

            if (!Array.isArray(news)) {
                console.error("API did not return an array:", news);
                alert("Something went wrong. Please check console or try again later.");
                return;
            }

            if (news.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center'>No news found.</td></tr>";
                return;
            }

            news.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.Title}</td>
                    <td>${item.PublicationDate}</td>
                    <td><a href="${item.Url}" target="_blank" class="btn btn-outline-primary btn-sm">Read More</a></td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
